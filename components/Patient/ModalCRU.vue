<template>
  <div>
    <b-modal id="bv-entity" size="lg" :title="method.charAt(0).toUpperCase() + method.slice(1) + ' Patient '" ref="bvEntity" @hide="onReset" :hide-footer="true">
      <b-form @submit.prevent="onSubmit" @reset.prevent="resetBtnPressed" v-if="show">
        <b-tabs content-class="p-2 pt-3">
          <b-tab title="Patient" active>
            <b-form-group
              id="input-group-id"
              label="Id:"
              label-for="input-id"
              label-class="font-weight-bold"
              v-if="fieldProperties('id').visible"
            >
              <b-form-input
                id="input-id"
                v-model="form.id"
                :disabled="!fieldProperties('id').editable"
              ></b-form-input>
            </b-form-group>
            <b-form-group
              id="input-group-email"
              label="E-mail:"
              label-for="input-email"
              label-class="font-weight-bold"
              v-if="fieldProperties('email').visible"
            >
              <b-form-input
                id="input-email"
                aria-describedby="input-email-feedback"
                v-model="form.email"
                :state="emailState"
                :disabled="!fieldProperties('email').editable"
                trim
                required
              ></b-form-input>
              <b-form-invalid-feedback id="input-email-feedback">
                {{form.emailError}}
              </b-form-invalid-feedback>
            </b-form-group>
            <b-form-group
              id="input-group-password"
              label="Password:"
              label-for="input-password"
              label-class="font-weight-bold"
              v-if="fieldProperties('password').visible"
            >
              <b-form-input
                id="input-password"
                aria-describedby="input-password-feedback"
                v-model="form.password"
                type="password"
                :state="passwordState"
                :disabled="!fieldProperties('password').editable"
                trim
                required
              ></b-form-input>
              <b-form-invalid-feedback id="input-password-feedback">
                {{form.passwordError}}
              </b-form-invalid-feedback>
            </b-form-group>
            <b-form-group
              id="input-group-name"
              label="Name:"
              label-for="input-name"
              label-class="font-weight-bold"
              v-if="fieldProperties('name').visible"
            >
              <b-form-input
                id="input-name"
                aria-describedby="input-name-feedback"
                v-model="form.name"
                :state="nameState"
                :disabled="!fieldProperties('name').editable"
                trim
                required
              ></b-form-input>
              <b-form-invalid-feedback id="input-name-feedback">
                {{form.nameError}}
              </b-form-invalid-feedback>
            </b-form-group>
            <b-form-group
              id="input-group-gender"
              label="Gender:"
              label-for="input-gender"
              label-class="font-weight-bold"
              v-if="fieldProperties('gender').visible"
            >
              <b-form-select
                id="input-gender"
                aria-describedby="input-gender-feedback"
                v-model="form.gender"
                :state="genderState"
                :disabled="!fieldProperties('gender').editable"
                :options="genderValues"
                required
              />
              <b-form-invalid-feedback id="input-gender-feedback">
                {{form.genderError}}
              </b-form-invalid-feedback>
            </b-form-group>
            <b-form-group
              id="input-group-healthNo"
              label="Health Number:"
              label-for="input-healthNo"
              label-class="font-weight-bold"
              v-if="fieldProperties('healthNo').visible"
            >
              <b-form-input
                id="input-healthNo"
                aria-describedby="input-healthNo-feedback"
                v-model="form.healthNo"
                :state="healthNoState"
                :disabled="!fieldProperties('healthNo').editable"
                trim
                required
              ></b-form-input>
              <b-form-invalid-feedback id="input-healthNo-feedback">
                {{form.healthNoError}}
              </b-form-invalid-feedback>
            </b-form-group>
          </b-tab>

          <b-tab id="biometric-datas-table" v-if="form.biometricDatas && form.biometricDatas.length > 0" title="Biometric Data">
            <b-table striped hover responsive :items="form.biometricDatas" :fields="fieldsBiometricData">
              <template #cell(created_at)="data">
                {{formatDate(data.item.created_at)}}
              </template>
            </b-table>
            <b-pagination
              v-if="form.biometricDatas.length > perPage"
              v-model="currentPageBiometricDatas"
              :total-rows="dataRowsBiometricDatas"
              :per-page="perPage"
              aria-controls="biometric-datas-table"
              align="center"
            ></b-pagination>
          </b-tab>

          <b-tab id="observations-table" title="Observations" v-if="form.observations && form.observations.length > 0">
            <b-table striped hover responsive :items="form.observations" :fields="fieldsObservations">
              <template #cell(created_at)="data">
                {{formatDate(data.item.created_at)}}
              </template>
              <template #cell(Documents)="data">
                {{data.item.nDocuments}}
              </template>
              <template #cell(Prescription)="data">
                <b-button
                  variant="warning"
                  @click="data.toggleDetails"
                  size="sm"
                  class="mr-2"
                  v-if="data.item.hasPrescription"
                >
                  <b-icon-pencil-fill></b-icon-pencil-fill>
                </b-button>
              </template>
            </b-table>
            <b-pagination
              v-if="form.observations.length > perPage"
              v-model="currentPageObservations"
              :total-rows="dataRowsObservations"
              :per-page="perPage"
              aria-controls="observations-table"
              align="center"
            ></b-pagination>
          </b-tab>
        </b-tabs>

        <b-button type="submit" variant="primary">{{this.method === 'create' ? 'Create' : 'Save'}}</b-button>
        <b-button type="reset" variant="danger">Reset</b-button>
      </b-form>
      <div v-else class="d-flex align-items-center justify-content-center">
        <b-spinner class="m-5" style="width: 3rem; height: 3rem;" label="Loading" />
      </div>
    </b-modal>
  </div>
</template>

<script>

export default {
  props:{
    entity:Object,
    method:String,
    modalShow: Boolean,
  },
  data() {
    return {
      form: {
        id: null,
        email: null,
        emailError: '',
        password: null,
        passwordError: '',
        name: null,
        nameError: '',
        gender: null,
        genderError: '',
        biometricDatas: [],
        observations: [],
        created_by: null,
        healthNo: null,
        healthNoError: '',
      },
      show: false,
      fieldsBiometricData: [
        {key: "value", sortable: true},
        {key: "valueUnit", sortable: true},
        {key: "biometricDataTypeName", sortable: true},
        {key: "created_at", sortable: true},
      ],
      fieldsObservations: [
        {key: "healthcareProfessionalName", sortable: true},
        {key: "created_at", sortable: true},
        {key: "Documents", sortable: true},
        {key: "Prescription", sortable: true},
      ],
      genderValues: [
        { value: 'Male', text: 'Male' },
        { value: 'Female', text: 'Female' },
        { value: 'Other', text: 'Other' }
      ],

      currentPageBiometricDatas: 1,
      currentPageObservations: 1,
      perPage: 4,
      clone: {},
    }
  },
  computed: {
    dataRowsBiometricDatas() {
      return this.form.biometricDatas
    },
    dataRowsObservations() {
      return this.form.observations
    },
    emailState(){
      if (this.form.email == "" || this.form.email == null) {
        return null
      }
      var re = /\S+@\S+\.\S+/;
      if (!re.test(this.form.email)) {
        this.form.emailError = "Invalid email!"
        return false
      }
      return true
    },
    nameState(){
      if (this.form.name == "" || this.form.name == null) {
        return null
      }
      if (!(this.form.name.length > 5)) {
        this.form.nameError = "Name need to contains at least 6 characters!"
        return false
      }
      return true
    },
    genderState(){
      if (this.form.gender == "" || this.form.gender == null) {
        return null
      }
      if (!(this.form.gender === 'Male' || this.form.gender === 'Female' || this.form.gender === 'Other')) {
        this.form.genderError = "Invalid gender!"
        return false
      }
      return true
    },
    passwordState(){
      if (this.form.password == "" || this.form.password == null) {
        return null
      }
      if (!(this.form.password.length > 3)) {
        this.form.passwordError = "Password need to contains at least 4 characters!"
        return false
      }
      return true
    },
    healthNoState(){
      if (this.form.healthNo == "" || this.form.healthNo == null) {
        return null
      }
      if (!(this.form.healthNo.length === 9)) {
        this.form.healthNoError = "Health number need to contains 9 numbers!"
        return false
      }
      return true
    }
  },
  methods: {
    showErrorMessage(err) {
      if (err.response) {
        this.$toast.error('ERROR: ' + err.response.data).goAway(3000);
      }
      else {
        this.$toast.error(err).goAway(3000);
      }
    },
    formatDate(dateStr) {
      let date = new Date(dateStr)
      return date.toLocaleString('pt-PT')
    },
    resetBtnPressed() {
      this.form = Object.assign({}, this.clone)
    },
    onReset() {
      this.$emit("onReset")
    },
    onSubmit() {
      this.$emit("onSubmit", this.form, this.method)
    },
    fieldProperties(fieldName) {
      switch (this.method) {
        case 'edit':
          if (fieldName === 'id') return { visible: true, editable: false }
          if (fieldName === 'email') return { visible: true, editable: true }
          if (fieldName === 'password') return { visible: false, editable: false }
          if (fieldName === 'name') return { visible: true, editable: true }
          if (fieldName === 'gender') return { visible: true, editable: true }
          if (fieldName === 'biometricDataHistory') return { visible: true, editable: false }
          if (fieldName === 'observations') return { visible: true, editable: false }
          if (fieldName === 'createdBy') return { visible: true, editable: false }
          if (fieldName === 'healthNo') return { visible: true, editable: true }
          break;
        case 'create':
          if (fieldName === 'id') return { visible: false, editable: false }
          if (fieldName === 'email') return { visible: true, editable: true }
          if (fieldName === 'password') return { visible: true, editable: true }
          if (fieldName === 'name') return { visible: true, editable: true }
          if (fieldName === 'gender') return { visible: true, editable: true }
          if (fieldName === 'biometricDataHistory') return { visible: false, editable: false }
          if (fieldName === 'observations') return { visible: false, editable: false }
          if (fieldName === 'createdBy') return { visible: false, editable: false }
          if (fieldName === 'healthNo') return { visible: true, editable: true }
          break;
        default: return { visible: true, editable: true }
      }
    },
  },
  watch: {
    modalShow(newVal){
      if (newVal === true) {
        this.$refs.bvEntity.show()
      }else{
        this.$refs.bvEntity.hide()
      }
    },
    entity(newEntity) {
      if (newEntity != null) {
        this.show = false
        if (this.method === 'edit') {
          this.$axios
            .$get('/api/patients/' + this.entity.id)
            .then(patient => {
              this.form.id = patient.id;
              this.form.email = patient.email;
              this.form.name = patient.name;
              this.form.gender = patient.gender;
              this.form.biometricDatas = patient.biometricDatas;
              this.form.observations = patient.observations;
              this.form.created_by = patient.created_by;
              this.form.healthNo = patient.healthNo+"";
              this.clone = Object.assign({}, this.form)
              this.show = true
            })
            .catch((err) => {
              this.showErrorMessage(err);
              this.$refs.bvEntity.hide()
              this.show = true
            })
        } else {
          this.form.id = ""
          this.form.email = ""
          this.form.name = ""
          this.form.gender = "Male"
          this.form.password = ""
          this.form.biometricDatas = ""
          this.form.observations = ""
          this.form.created_by = ""
          this.form.healthNo = ""
          this.clone = Object.assign({}, this.form)
          this.show = true
        }
        this.$refs.bvEntity.show()
      }
    }
  }
}
</script>

<style>

</style>
